!function(t,e){"function"==typeof define&&define.amd?define(["jquery","store"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("store")):t.jqOAuth=e(t.jQuery,t.store)}(this,function(t,e){var o=function(e){this.options={},this.data={},this.intercept=!1,this.refreshing=!1,this.buffer=[],this.currentRequests=[],this._resetOptions(),this._setupInterceptor(),t.extend(this.options,e),this._hasStoredData()?(this._getStoredData(),this.hasAccessToken()&&this.login(this.data.accessToken)):(this._resetData(),this._updateStorage())};return o.prototype.getAccessToken=function(){return this.data.accessToken},o.prototype.hasAccessToken=function(){return null!==this.data.accessToken},o.prototype.logout=function(){this._resetData(),this._updateStorage(),this._deactivateInterceptor(),this._fireEvent("logout")},o.prototype.login=function(t){this.setAccessToken(t),this._activateInterceptor(),this._fireEvent("login")},o.prototype.setAccessToken=function(t){this.data.accessToken=t,this._updateStorage()},o.prototype.setCsrfToken=function(t){this.options.csrfToken=t},o.prototype._activateInterceptor=function(){this.intercept=!0},o.prototype._addToBuffer=function(t,e){this.buffer.push({deferred:e,settings:t})},o.prototype._clearBuffer=function(){this.buffer=[]},o.prototype._deactivateInterceptor=function(){this.intercept=!1},o.prototype._fireBuffer=function(){var e,o=this,r=[];for(var s in this.buffer)e=this.buffer[s].deferred,this.buffer[s].settings.refreshRetry=!0,r.push(t.ajax(this.buffer[s].settings).always(function(t){401===t.status&&o.logout()}).then(e.resolve,e.reject));this._clearBuffer(),o._setRefreshingFlag(!1)},o.prototype._fireEvent=function(t){if(this._hasEvent(t))return this.options.events[t]()},o.prototype._getStoredData=function(){t.extend(this.data,e.get(this.options.tokenName))},o.prototype._hasEvent=function(t){return void 0!==this.options.events[t]&&"function"==typeof this.options.events[t]},o.prototype._hasFilter=function(t){return void 0!==this.options.filters[t]&&"function"==typeof this.options.filters[t]},o.prototype._hasStoredData=function(){return void 0!==e.get(this.options.tokenName)},o.prototype._resetData=function(){this.data={accessToken:null}},o.prototype._resetOptions=function(){this.options={bufferInterval:25,bufferWaitLimit:500,csrfToken:null,events:{},tokenName:"jquery.oauth",filters:{}}},o.prototype._setAjaxHeader=function(e,o){this._isAjaxHeadersInitialized()||(t.ajaxSettings.headers={}),t.ajaxSettings.headers[e]=o},o.prototype._setRefreshingFlag=function(t){this.refreshing=t},o.prototype._hasCSRFToken=function(){return this.options.csrfToken},o.prototype._setupInterceptor=function(){var e=this;t.ajaxPrefilter(function(o,r,s){if(e._shouldAddAuthorization(o)&&s.setRequestHeader("Authorization","Bearer "+e.data.accessToken),e._hasCSRFToken()&&s.setRequestHeader("X-CSRF-Token",this.options.csrfToken),o.refreshRetry!==!0){var n=t.Deferred();return e.currentRequests.push(o.url),s.always(function(){e.currentRequests.splice(t.inArray(o.url,e.currentRequests),1)}),s.done(n.resolve),s.fail(function(){var t=Array.prototype.slice.call(arguments);e.intercept&&401===s.status&&e._hasEvent("tokenExpiration")?(e._addToBuffer(o,n),e.refreshing||(e._setRefreshingFlag(!0),e._fireEvent("tokenExpiration").then(function(){var t=0;e.interval=setInterval(function(){t+=e.options.bufferInterval,(0===e.currentRequests.length||t>=e.options.bufferWaitLimit)&&(clearInterval(e.interval),e._fireBuffer())},e.options.bufferInterval)}).fail(function(){e.logout()}))):n.rejectWith(s,t)}),n.promise(s)}})},o.prototype._shouldAddAuthorization=function(t){return!this._hasFilter("url")||this.options.filters.url(t.url)},o.prototype._updateStorage=function(){e.set(this.options.tokenName,this.data)},o});